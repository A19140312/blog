---
title: Javaè™šæ‹Ÿæœº
date: 2019-12-30 17:47:00
tags:
    - JVM
    - JAVA
    - å­¦ä¹ ç¬”è®°
categories: JVM
author: Guyuqing
copyright: true
comments: false
---
Javaè™šæ‹Ÿæœº(java virtual machineï¼ŒJVM)ï¼Œä¸€ç§èƒ½å¤Ÿè¿è¡Œjavaå­—èŠ‚ç çš„è™šæ‹Ÿæœºã€‚ä½œä¸ºä¸€ç§ç¼–ç¨‹è¯­è¨€çš„è™šæ‹Ÿæœºï¼Œå®é™…ä¸Šä¸åªæ˜¯ä¸“ç”¨äºJavaè¯­è¨€ï¼Œåªè¦ç”Ÿæˆçš„ç¼–è¯‘æ–‡ä»¶åŒ¹é…JVMå¯¹åŠ è½½ç¼–è¯‘æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼Œä»»ä½•è¯­è¨€éƒ½å¯ä»¥ç”±JVMç¼–è¯‘è¿è¡Œã€‚ æ¯”å¦‚kotlinã€scalaç­‰ã€‚
<!-- more -->
# JVMåŸºæœ¬ç»“æ„
JVMç”±ä¸‰ä¸ªä¸»è¦çš„å­ç³»ç»Ÿæ„æˆ
* ç±»åŠ è½½å­ç³»ç»Ÿ
* è¿è¡Œæ—¶æ•°æ®åŒº(å†…å­˜ç»“æ„)
* æ‰§è¡Œå¼•æ“
![](JVM-Fundamentals/1.png)

## ç±»åŠ è½½æœºåˆ¶
### ç±»çš„ç”Ÿå‘½å‘¨æœŸ
![](JVM-Fundamentals/2.png)
1. åŠ è½½ï¼šå°†.classæ–‡ä»¶ä»ç£ç›˜è¯»åˆ°å†…å­˜
    * é€šè¿‡ç±»çš„å…¨é™å®šå(com.xxx.xxx)+ç±»åŠ è½½å™¨ç¡®å®šå”¯ä¸€çš„ç±»ï¼Œæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ
    * å°†è¿™ä¸ªç±»å­—èŠ‚æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
    * åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨æ­¤ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºè®¿é—®æ–¹æ³•åŒºè¿™äº›æ•°æ®ç»“æ„çš„å…¥å£ã€‚
2. è¿æ¥
    1. éªŒè¯ï¼šéªŒè¯å­—èŠ‚ç æ–‡ä»¶çš„æ­£ç¡®æ€§
        * æ–‡ä»¶æ ¼å¼éªŒè¯ï¼šåŸºäºå­—èŠ‚æµéªŒè¯ã€‚
        * å…ƒæ•°æ®éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ã€‚
        * å­—èŠ‚ç éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ã€‚
        * ç¬¦å·å¼•ç”¨éªŒè¯ï¼šåŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„éªŒè¯ã€‚
    2. å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶èµ‹äºˆ`é»˜è®¤å€¼`ï¼ˆä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼‰
        * public static int value = 123; //æ­¤æ—¶åœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º0è€Œä¸æ˜¯123ï¼Œåœ¨åˆå§‹åŒ–è¿‡ç¨‹æ‰ä¼šè¢«èµ‹å€¼ä¸º123
        * public static final int value = 123;//valueçš„å€¼åœ¨å‡†å¤‡é˜¶æ®µè¿‡åå°±æ˜¯123ã€‚
    3. è§£æï¼šç±»è£…è½½å™¨è£…å…¥ç±»æ‰€å¼•ç”¨çš„å…¶å®ƒæ‰€æœ‰ç±»
3. åˆå§‹åŒ–ï¼šä¸ºç±»çš„é™æ€å˜é‡èµ‹äºˆæ­£ç¡®çš„åˆå§‹å€¼ï¼Œä¸Šè¿°çš„å‡†å¤‡é˜¶æ®µä¸ºé™æ€å˜é‡èµ‹äºˆçš„æ˜¯è™šæ‹Ÿæœºé»˜è®¤çš„åˆå§‹å€¼ï¼Œæ­¤å¤„èµ‹äºˆçš„æ‰æ˜¯ç¨‹åºç¼–å†™è€…ä¸ºå˜é‡åˆ†é…çš„çœŸæ­£çš„åˆå§‹å€¼ï¼Œæ‰§è¡Œé™æ€ä»£ç å—
4. ä½¿ç”¨
5. å¸è½½

### ç±»åŠ è½½å™¨çš„ç§ç±»
æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤ç§ï¼šå¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆC++å®ç°ï¼‰ å’Œ å…¶ä»–ç±»åŠ è½½å™¨ï¼ˆJAVAå®ç°ï¼‰
#### å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)
è´Ÿè´£åŠ è½½JREçš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚JREç›®æ ‡ä¸‹çš„rt.jarï¼Œcharsets.jarç­‰
#### æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)
è´Ÿè´£åŠ è½½JREæ‰©å±•ç›®å½•extä¸­jarç±»åŒ…
#### ç³»ç»Ÿç±»åŠ è½½å™¨(Application ClassLoader)
è´Ÿè´£åŠ è½½ClassPathè·¯å¾„ä¸‹çš„ç±»åŒ…
#### ç”¨æˆ·è‡ªå®šä¹‰åŠ è½½å™¨(User ClassLoader)
è´Ÿè´£åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„ä¸‹çš„ç±»åŒ…

![](JVM-Fundamentals/3.png)

### ç±»åŠ è½½æœºåˆ¶
#### å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶
å½“ä¸€ä¸ªClassLoaderåŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œé™¤éæ˜¾ç¤ºçš„ä½¿ç”¨å¦ä¸€ä¸ªClassLoaderï¼Œè¯¥ç±»æ‰€ä¾èµ–å’Œå¼•ç”¨çš„ç±»ä¹Ÿç”±è¿™ä¸ª ClassLoaderè½½å…¥

#### åŒäº²å§”æ´¾æœºåˆ¶
æŒ‡å…ˆå§”æ‰˜çˆ¶ç±»åŠ è½½å™¨å¯»æ‰¾ç›®æ ‡ç±»ï¼Œåœ¨æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹ï¼Œåœ¨è‡ªå·±çš„è·¯å¾„ä¸­æŸ¥æ‰¾å¹¶è½½å…¥ç›®æ ‡ç±»
![](JVM-Fundamentals/4.png)
1. å½“æœ‰ç±»éœ€è¦åŠ è½½ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰çˆ¶ç±»ï¼Œæœ‰äº¤ç»™æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½
2. æ‰©å±•ç±»åŠ è½½å™¨åˆ¤æ–­æœ‰æ²¡æœ‰çˆ¶ç±»ï¼Œæœ‰äº¤ç»™å¯åŠ¨ç±»åŠ è½½å™¨
3. å¯åŠ¨ç±»åŠ è½½å™¨æ²¡æœ‰çˆ¶ç±»ï¼Œå»å®é™…åŠ è½½è¯¥ç±»ï¼Œè¯¥ç±»ä¸æ˜¯JREåŒ…ä¸‹çš„ç±»ï¼Œäº¤ç»™å­ç±»æ‰©å±•ç±»åŠ è½½å™¨å»åŠ è½½
4. æ‰©å±•ç±»åŠ è½½å™¨å»åŠ è½½è¯¥ç±»ï¼Œå‘ç°è¯¥ç±»ä¸æ˜¯extä¸­çš„åŒ…ï¼Œäº¤ç»™ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½
5. ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ï¼Œå‘ç°æ˜¯classPathè·¯å¾„ä¸‹çš„åŒ…ï¼Œè¿›è¡ŒåŠ è½½ã€‚

##### åŒäº²å§”æ´¾æ¨¡å¼çš„ä¼˜åŠ¿
* æ²™ç®±å®‰å…¨æœºåˆ¶:æ¯”å¦‚è‡ªå·±å†™çš„String.classç±»ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢æ ¸å¿ƒåº“è¢«éšæ„ç¯¡æ”¹
* é¿å…ç±»çš„é‡å¤åŠ è½½:å½“çˆ¶ClassLoaderå·²ç»åŠ è½½äº†è¯¥ç±»çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦å­ClassLoaderå†åŠ è½½ä¸€æ¬¡

##### ä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å¼
ä¾‹å¦‚ï¼štomcat 
Tomcatæ˜¯ä¸ªwebå®¹å™¨,å¯èƒ½éœ€è¦éƒ¨ç½²ä¸¤ä¸ªåº”ç”¨ç¨‹åºï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“çš„ä¸åŒç‰ˆæœ¬ï¼Œä¸èƒ½è¦æ±‚åŒä¸€ä¸ªç±»åº“åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨åªæœ‰ä¸€ä»½ï¼Œå› æ­¤è¦ä¿è¯æ¯ä¸ªåº”ç”¨ç¨‹åºçš„ç±»åº“éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¿è¯ç›¸äº’éš”ç¦»ã€‚Â 
å¦‚æœä½¿ç”¨é»˜è®¤çš„ç±»åŠ è½½å™¨æœºåˆ¶ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•åŠ è½½ä¸¤ä¸ªç›¸åŒç±»åº“çš„ä¸åŒç‰ˆæœ¬çš„ï¼Œé»˜è®¤çš„ç±»åŠ è½½å™¨æ˜¯ä¸ç®¡ä½ æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„ï¼Œåªåœ¨ä¹ä½ çš„å…¨é™å®šç±»åï¼Œå¹¶ä¸”åªæœ‰ä¸€ä»½ã€‚

##### å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å¼
1. ç»§æ‰¿ClassLoader
2. é‡å†™findClass()æ–¹æ³•
3. é‡å†™loadClass()æ–¹æ³•

## è¿è¡Œæ—¶æ•°æ®åŒº(å†…å­˜ç»“æ„)
![](JVM-Fundamentals/5.png)

### è™šæ‹Ÿæœºæ ˆ
javaè™šæ‹Ÿæœºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ¯ä¸ªæ–¹æ³•æ‰§è¡Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•å‡ºå£ç­‰ã€‚

#### æ ˆä¸æ ˆå¸§
æ¯ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œåˆ°æ‰§è¡Œå®Œæˆï¼Œå¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚javaè™šæ‹Ÿæœºæ ˆæ ˆé¡¶çš„æ ˆå¸§å°±æ˜¯å½“å‰æ‰§è¡Œæ–¹æ³•çš„æ ˆå¸§ã€‚PCå¯„å­˜å™¨ä¼šæŒ‡å‘è¯¥åœ°å€ã€‚å½“è¿™ä¸ªæ–¹æ³•è°ƒç”¨å…¶ä»–æ–¹æ³•çš„æ—¶å€™ä¹…ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œè¿™ä¸ªæ–°çš„æ ˆå¸§ä¼šè¢«æ–¹æ³•Javaè™šæ‹Ÿæœºæ ˆçš„æ ˆé¡¶ï¼Œå˜ä¸ºå½“å‰çš„æ´»åŠ¨æ ˆï¼Œåœ¨å½“å‰åªæœ‰å½“å‰æ´»åŠ¨æ ˆçš„æœ¬åœ°å˜é‡æ‰èƒ½è¢«ä½¿ç”¨ï¼Œå½“è¿™ä¸ªæ ˆå¸§æ‰€æœ‰æŒ‡ä»¤éƒ½å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§»é™¤ï¼Œä¹‹å‰çš„æ ˆå¸§å˜ä¸ºæ´»åŠ¨æ ˆï¼Œå‰é¢ç§»é™¤æ ˆå¸§çš„è¿”å›å€¼å˜ä¸ºè¿™ä¸ªæ ˆå¸§çš„ä¸€ä¸ªæ“ä½œæ•°ã€‚

#### æ ˆå¸§
æ ˆå¸§åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€

##### å±€éƒ¨å˜é‡è¡¨
* å±€éƒ¨å˜é‡è¡¨æ˜¯å˜é‡å€¼çš„å­˜å‚¨ç©ºé—´ï¼Œç”¨äºå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚åœ¨javaç¼–è¯‘æˆclassæ–‡ä»¶çš„æ—¶å€™ï¼Œå°±åœ¨æ–¹æ³•çš„Codeå±æ€§çš„max_localsæ•°æ®é¡¹ä¸­ç¡®å®šè¯¥æ–¹æ³•éœ€è¦åˆ†é…çš„æœ€å¤§å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ã€‚
* å±€éƒ¨å˜é‡è¡¨çš„å®¹é‡ä»¥å˜é‡æ§½ï¼ˆSlotï¼‰ä¸ºæœ€å°å•ä½ï¼Œ32ä½è™šæ‹Ÿæœºä¸­ä¸€ä¸ªSlotå¯ä»¥å­˜æ”¾32ä½ï¼ˆ4 å­—èŠ‚ï¼‰ä»¥å†…çš„æ•°æ®ç±»å‹ï¼ˆ booleanã€byteã€charã€shortã€intã€floatã€referenceå’ŒreturnAddresså…«ç§ï¼‰
* å¯¹äº64ä½é•¿åº¦çš„æ•°æ®ç±»å‹ï¼ˆlongï¼Œdoubleï¼‰ï¼Œè™šæ‹Ÿæœºä¼šä»¥é«˜ä½å¯¹é½æ–¹å¼ä¸ºå…¶åˆ†é…`ä¸¤ä¸ªè¿ç»­çš„Slot`ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæŠŠä¸€æ¬¡longå’Œdoubleæ•°æ®ç±»å‹è¯»å†™åˆ†å‰²æˆä¸ºä¸¤æ¬¡32ä½è¯»å†™ã€‚
* referenceç±»å‹è™šæ‹Ÿæœºè§„èŒƒæ²¡æœ‰æ˜ç¡®è¯´æ˜å®ƒçš„é•¿åº¦ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œè™šæ‹Ÿæœºå®ç°è‡³å°‘éƒ½åº”å½“èƒ½ä»æ­¤å¼•ç”¨ä¸­ç›´æ¥æˆ–è€…é—´æ¥åœ°æŸ¥æ‰¾åˆ°å¯¹è±¡åœ¨Javaå †ä¸­çš„èµ·å§‹åœ°å€ç´¢å¼•å’Œæ–¹æ³•åŒºä¸­çš„å¯¹è±¡ç±»å‹æ•°æ®ã€‚
* Slotæ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œå½“Slotä¸­çš„å˜é‡è¶…å‡ºäº†ä½œç”¨åŸŸï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡åˆ†é…Slotçš„æ—¶å€™ï¼Œå°†ä¼šè¦†ç›–åŸæ¥çš„æ•°æ®ã€‚Slotå¯¹å¯¹è±¡çš„å¼•ç”¨ä¼šå½±å“GCï¼ˆè¦æ˜¯è¢«å¼•ç”¨ï¼Œå°†ä¸ä¼šè¢«å›æ”¶ï¼‰ã€‚Â Â 
* ç³»ç»Ÿä¸ä¼šä¸ºå±€éƒ¨å˜é‡èµ‹äºˆåˆå§‹å€¼ï¼ˆå®ä¾‹å˜é‡å’Œç±»å˜é‡éƒ½ä¼šè¢«èµ‹äºˆåˆå§‹å€¼ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸å­˜åœ¨ç±»å˜é‡é‚£æ ·çš„å‡†å¤‡é˜¶æ®µã€‚

##### æ“ä½œæ•°æ ˆ
* æ“ä½œæ•°æ ˆå’Œå±€éƒ¨å˜é‡è¡¨ä¸€æ ·ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸå°±å·²ç»ç¡®å®šäº†è¯¥æ–¹æ³•æ‰€éœ€è¦åˆ†é…çš„å±€éƒ¨å˜é‡è¡¨çš„æœ€å¤§å®¹é‡ã€‚
* æ“ä½œæ•°æ ˆçš„æ¯ä¸€ä¸ªå…ƒç´ å¯ç”¨æ˜¯ä»»æ„çš„Javaæ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬longå’Œdoubleã€‚32ä½æ•°æ®ç±»å‹æ‰€å çš„æ ˆå®¹é‡ä¸º1ï¼Œ64ä½æ•°æ®ç±»å‹å ç”¨çš„æ ˆå®¹é‡ä¸º2ã€‚
* å½“ä¸€ä¸ªæ–¹æ³•åˆšåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å„ç§å­—èŠ‚ç æŒ‡ä»¤å¾€æ“ä½œæ•°æ ˆä¸­å†™å…¥å’Œæå–å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å‡ºæ ˆ / å…¥æ ˆæ“ä½œï¼ˆä¾‹å¦‚ï¼šåœ¨åšç®—æœ¯è¿ç®—çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œçš„ï¼Œåˆæˆ–è€…åœ¨è°ƒç”¨å…¶å®ƒæ–¹æ³•çš„æ—¶å€™æ˜¯é€šè¿‡æ“ä½œæ•°æ ˆæ¥è¿›è¡Œå‚æ•°ä¼ é€’çš„ï¼‰ã€‚

##### åŠ¨æ€è¿æ¥
ç›´æ¥å¼•ç”¨ï¼šæœ‰å…·ä½“å¼•ç”¨åœ°å€çš„æŒ‡é’ˆï¼Œè¢«å¼•ç”¨çš„ç±»ã€æ–¹æ³•æˆ–è€…å˜é‡å·²ç»è¢«åŠ è½½åˆ°å†…å­˜ä¸­
ç¬¦å·å¼•ç”¨ï¼šå³ç”¨ç”¨å­—ç¬¦ä¸²ç¬¦å·çš„å½¢å¼æ¥è¡¨ç¤ºå¼•ç”¨ï¼Œå…¶å®è¢«å¼•ç”¨çš„ç±»ã€æ–¹æ³•æˆ–è€…å˜é‡è¿˜æ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚
ä¸¾ä¸ªä¾‹å­ï¼š
```java
/**
* ç¬¦å·å¼•ç”¨
*/
String str = "abc";
System.out.println("str=" + str);
/**
* ç›´æ¥å¼•ç”¨
*/
System.out.println("str=" + "abc");
```

åŠ¨æ€é“¾æ¥ï¼šåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ã€‚
é™æ€é“¾æ¥ï¼šåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œç”±ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ã€‚

##### æ–¹æ³•è¿”å›åœ°å€
å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå¯èƒ½æœ‰ä¸¤ç§æ–¹å¼é€€å‡ºè¯¥æ–¹æ³•ï¼š
* æ­£å¸¸å®Œæˆå‡ºå£
    * æ­£å¸¸å®Œæˆå‡ºå£æ˜¯æŒ‡æ–¹æ³•æ­£å¸¸å®Œæˆå¹¶é€€å‡ºï¼Œæ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸(åŒ…æ‹¬Javaè™šæ‹Ÿæœºå¼‚å¸¸ä»¥åŠæ‰§è¡Œæ—¶é€šè¿‡throwè¯­å¥æ˜¾ç¤ºæŠ›å‡ºçš„å¼‚å¸¸)ã€‚å¦‚æœå½“å‰æ–¹æ³•æ­£å¸¸å®Œæˆï¼Œåˆ™æ ¹æ®å½“å‰æ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™æ—¶æœ‰å¯èƒ½ä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™æ–¹æ³•è°ƒç”¨è€…(è°ƒç”¨å®ƒçš„æ–¹æ³•)ï¼Œæˆ–è€…æ— è¿”å›å€¼ã€‚å…·ä½“æ˜¯å¦æœ‰è¿”å›å€¼ä»¥åŠè¿”å›å€¼çš„æ•°æ®ç±»å‹å°†æ ¹æ®è¯¥æ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ç¡®å®šã€‚
* å¼‚å¸¸å®Œæˆå‡ºå£
    * å¼‚å¸¸å®Œæˆå‡ºå£æ˜¯æŒ‡æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸åœ¨æ–¹æ³•ä½“å†…éƒ¨æ²¡æœ‰å¾—åˆ°å¤„ç†ï¼Œå¯¼è‡´æ–¹æ³•é€€å‡ºã€‚
    
æ— è®ºæ–¹æ³•é‡‡ç”¨ä½•ç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½éœ€è¦è¿”å›åˆ°æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ï¼Œç¨‹åºæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œæ–¹æ³•è¿”å›æ—¶å¯èƒ½éœ€è¦åœ¨å½“å‰æ ˆå¸§ä¸­ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œç”¨æ¥å¸®ä»–æ¢å¤å®ƒçš„ä¸Šå±‚æ–¹æ³•æ‰§è¡ŒçŠ¶æ€ã€‚
æ–¹æ³•é€€å‡ºè¿‡ç¨‹å®é™…ä¸Šå°±ç­‰åŒäºæŠŠå½“å‰æ ˆå¸§å‡ºæ ˆï¼Œå› æ­¤é€€å‡ºå¯ä»¥æ‰§è¡Œçš„æ“ä½œæœ‰ï¼šæ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆï¼ŒæŠŠè¿”å›å€¼(å¦‚æœæœ‰çš„è¯)å‹å¦‚è°ƒç”¨è€…çš„æ“ä½œæ•°æ ˆä¸­ï¼Œè°ƒæ•´PCè®¡æ•°å™¨çš„å€¼ä»¥æŒ‡å‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚
ä¸€èˆ¬æ¥è¯´ï¼Œæ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å€¼å¯ä»¥ä½œä¸ºè¿”å›åœ°å€ï¼Œæ ˆå¸§ä¸­å¯èƒ½ä¿å­˜æ­¤è®¡æ•°å€¼ã€‚è€Œæ–¹æ³•å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€æ˜¯é€šè¿‡å¼‚å¸¸å¤„ç†å™¨è¡¨ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜æ­¤éƒ¨åˆ†ä¿¡æ¯ã€‚

```java
public class Demo {
    public int math(){
        int a = 1;
        int b = 2;
        int c = (a + b)*10;
        return c;
    }
    public static void main(String[] args) {
        Demo demo = new Demo();
        demo.math();
    }
}
```
å½“æ‰§è¡ŒğŸ‘†Demoçš„mathæ–¹æ³•æ—¶ï¼Œä¸»çº¿ç¨‹å†…å­˜ä¼šå¦‚ä½•æ“ä½œ
![](JVM-Fundamentals/5.1.png)
ç¬¬ä¸€æ­¥ï¼Œç°å°†1æ”¾å…¥`æ“ä½œæ•°æ ˆ`
![](JVM-Fundamentals/5.2.png)
ç¬¬äºŒæ­¥ï¼Œå°†1æ”¾å…¥`å±€éƒ¨å˜é‡è¡¨`ä¸­ç¬¬ä¸€ä¸ªæ§½é‡Œ
![](JVM-Fundamentals/5.3.png)
ç¬¬ä¸‰æ­¥ï¼Œç¬¬å››æ­¥åŒä¸Šï¼Œæœ€ç»ˆå°†2æ”¾å…¥`å±€éƒ¨å˜é‡è¡¨`ä¸­ç¬¬äºŒä¸ªæ§½é‡Œ
![](JVM-Fundamentals/5.4.png)
ç¬¬äº”æ­¥ï¼Œå°†1å¤åˆ¶ä¸€ä»½æ”¾å…¥`æ“ä½œæ•°æ ˆ`çš„æ ˆé¡¶
ç¬¬å…­æ­¥ï¼Œå°†2å¤åˆ¶ä¸€ä»½æ”¾å…¥`æ“ä½œæ•°æ ˆ`çš„æ ˆé¡¶
![](JVM-Fundamentals/5.5.png)
ç¬¬ä¸ƒæ­¥ï¼Œå°†2ï¼Œ1å¼¹å‡ºæ“ä½œæ•°æ ˆäº¤ç»™cpuå»è¿ç®—å¾—åˆ°3ï¼Œæ”¾åˆ°`æ“ä½œæ•°æ ˆ`çš„æ ˆé¡¶
![](JVM-Fundamentals/5.6.png)
ç¬¬å…«æ­¥ï¼Œä»å¸¸é‡æ± ï¼ˆ-128ï½127ï¼‰é‡Œæ‹¿åˆ°10ï¼Œæ”¾å…¥`æ“ä½œæ•°æ ˆ`é¡¶
![](JVM-Fundamentals/5.7.png)
ç¬¬ä¹æ­¥ï¼Œå¼¹å‡º10ï¼Œ3äº¤ç»™cpuå»è¿ç®—å¾—åˆ°30ï¼Œæ”¾åˆ°`æ“ä½œæ•°æ ˆ`çš„æ ˆé¡¶ï¼ˆjvm1.6å¼€å§‹è¿›è¡Œäº†æŒ‡ä»¤ä¼˜åŒ–ï¼Œç¬¬8ã€9æ­¥åˆå¹¶æˆäº†ä¸€æ­¥æ“ä½œï¼‰
![](JVM-Fundamentals/5.8.png)
ç¬¬åæ­¥ï¼Œå°†30æ”¾åˆ°`å±€éƒ¨å˜é‡è¡¨`ä¸­ç¬¬3ä¸ªæ§½é‡Œã€‚
![](JVM-Fundamentals/5.9.png)
ç¬¬åä¸€æ­¥ï¼Œå°†30å¤åˆ¶ä¸€ä»½æ”¾å…¥`æ“ä½œæ•°æ ˆ`ç¬¬æ ˆé¡¶ã€‚
ç¬¬åäºŒæ­¥ï¼Œå°†30å¼¹å‡ºæ“ä½œæ•°æ ˆï¼Œé€šè¿‡`è¿”å›åœ°å€`è¿”å›ã€‚

### ç¨‹åºè®¡æ•°å™¨
å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•åŒºä¸­çš„æ–¹æ³•å­—èŠ‚ç (ç”¨æ¥å­˜å‚¨**æŒ‡å‘ä¸‹ä¸€è·³æŒ‡ä»¤çš„åœ°å€**ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç )ï¼Œ
ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œç”¨æ¥ä¿è¯çº¿ç¨‹é—´åˆ‡æ¢åæ­£ç¡®æ‰§è¡Œã€‚

### æœ¬åœ°æ–¹æ³•æ ˆ
å’Œæ ˆä½œç”¨å¾ˆç›¸ä¼¼ï¼ŒåŒºåˆ«ä¸è¿‡æ˜¯Javaæ ˆä¸ºJVMæ‰§è¡ŒJavaæ–¹æ³•æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºJVMæ‰§è¡Œnativeæ–¹æ³•æœåŠ¡ã€‚
ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨Execution Engineæ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚

### æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£/æŒä¹…ä»£ï¼Œå…ƒç©ºé—´ï¼‰
ç±»çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•å­—èŠ‚ç ï¼Œä»¥åŠä¸€äº›ç‰¹æ®Šæ–¹æ³•å¦‚æ„é€ å‡½æ•°ï¼Œæ¥å£ä»£ç ä¹Ÿåœ¨è¿™é‡Œå®šä¹‰ã€‚
ç®€å•æ¥è¯´ï¼Œæ‰€æœ‰å®šä¹‰çš„æ–¹æ³•çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨è¯¥åŒºåŸŸï¼Œé™æ€å˜é‡+å¸¸é‡+ç±»ä¿¡æ¯(æ„é€ æ–¹æ³•/æ¥å£å®šä¹‰)+è¿è¡Œæ—¶å¸¸é‡æ± éƒ½å­˜åœ¨æ–¹æ³•åŒºä¸­ï¼Œ
è™½ç„¶Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heap(éå †)ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ºäº†å’ŒJavaçš„å †åŒºåˆ†å¼€(jdk1.8ä»¥å‰hotspotè™šæ‹Ÿæœºå«æ°¸ä¹…ä»£ã€æŒä¹…ä»£ï¼Œjdk1.8æ—¶å«å…ƒç©ºé—´)

æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´åŒºåˆ«åœ¨äºå…ƒæ•°æ®åŒºä¸åœ¨è™šæ‹Ÿæœºå½“ä¸­ï¼Œè€Œæ˜¯ç”¨çš„`æœ¬åœ°å†…å­˜`ï¼Œæ°¸ä¹…ä»£åœ¨è™šæ‹Ÿæœºå½“ä¸­ï¼Œæ°¸ä¹…ä»£é€»è¾‘ç»“æ„ä¸Šä¹Ÿå±äºå †ï¼Œä½†æ˜¯ç‰©ç†ä¸Šä¸å±äºã€‚

#### ä¸ºä»€ä¹ˆç§»é™¤äº†æ°¸ä¹…ä»£?
å‚è€ƒå®˜æ–¹è§£é‡Šhttp://openjdk.java.net/jeps/122
å¤§æ¦‚æ„æ€æ˜¯ç§»é™¤æ°¸ä¹…ä»£æ˜¯ä¸ºèåˆHotSpotä¸ JRockitè€Œåšå‡ºçš„åŠªåŠ›ï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£ã€‚
![](JVM-Fundamentals/7.png)


### å †
è™šæ‹Ÿæœºå¯åŠ¨æ—¶è‡ªåŠ¨åˆ†é…åˆ›å»ºï¼Œç”¨äºå­˜æ”¾`å¯¹è±¡`çš„å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå½“å¯¹è±¡æ— æ³•åœ¨è¯¥ç©ºé—´ç”³è¯·åˆ°å†…
å­˜æ˜¯å°†æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚åŒæ—¶ä¹Ÿæ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸã€‚
![](JVM-Fundamentals/6.jpeg)

#### æ–°ç”Ÿä»£(Young Generation)
ç±»å‡ºç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªç±»åœ¨è¿™é‡Œäº§ç”Ÿï¼Œåº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ï¼Œç»“æŸç”Ÿå‘½ã€‚
æ–°ç”Ÿä»£åˆ†ä¸ºä¸¤éƒ¨åˆ†:`ä¼Šç”¸åŒº`(Eden space)å’Œ`å¹¸å­˜è€…åŒº`(Survivor space)ï¼Œæ‰€æœ‰çš„ç±»éƒ½æ˜¯åœ¨ä¼Šç”¸åŒºè¢«newå‡ºæ¥çš„ã€‚
å¹¸å­˜åŒº(Survivor space):åˆ†ä¸ºFromå’ŒToåŒº,TOåŒºæ°¸è¿œä¿æŒç©ºã€‚
å½“EdenåŒºçš„ç©ºé—´ç”¨å®Œæ˜¯ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†EdenåŒºè¿›è¡Œåƒåœ¾å›æ”¶(`Minor GC`)ï¼Œå°†EdenåŒºä¸­çš„ä¸å†è¢«å…¶å®ƒå¯¹è±¡åº”ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚
ç„¶åå°†EdenåŒºä¸­å‰©ä½™çš„å¯¹è±¡ç§»åˆ°From SurvivoråŒºã€‚è‹¥From SurvivoråŒºä¹Ÿæ»¡äº†ï¼Œå†å¯¹è¯¥åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç„¶åç§»åŠ¨åˆ°To SurvivoråŒºï¼ŒFromåŒºä¸ºç©ºåï¼Œå°†Toå’ŒFromåŒºè½¬æ¢ï¼Œä¿è¯ToåŒºä¸ºç©ºï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„åŠ ä¸€ã€‚
å½“å¯¹è±¡å¹´é¾„é»˜è®¤åŠ åˆ°15ï¼ˆå› ä¸º**å¯¹è±¡å¤´åªæœ‰4ä¸ªbits**æ˜¯å­˜å¯¹è±¡å¹´é¾„ï¼Œæœ€å¤§ä¸º15ï¼‰æ—¶å°†å‰©ä¸‹çš„å¯¹è±¡ç§»åˆ°è€å¹´ä»£ã€‚

### è€å¹´ä»£(Old Generation)
æ–°ç”Ÿä»£ç»è¿‡å¤šæ¬¡GCä»ç„¶å­˜è´§çš„å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´åŒºã€‚
è‹¥è€å¹´ä»£ä¹Ÿæ»¡äº†ï¼Œè¿™æ—¶å€™å°†å‘ç”ŸMajor GC(ä¹Ÿå¯ä»¥å«`Full GC`)ï¼Œ è¿›è¡Œè€å¹´åŒºçš„å†…å­˜æ¸…ç†ã€‚
è‹¥è€å¹´åŒºæ‰§è¡Œäº†Full GCä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šæŠ›å‡º OOM(OutOfMemoryError)å¼‚å¸¸.


## GCç®—æ³•å’Œæ”¶é›†å™¨
å‡ ç§å¸¸è§GCï¼š
MinorGC/YoungGC æ–°ç”Ÿä»£
OldGC CMSç‰¹æœ‰
FullGC/MajorGC å›æ”¶æ‰€æœ‰
MixedGCï¼ˆFullGC+YoungGCï¼‰  G1ç‰¹æœ‰

### å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶
å †ä¸­å‡ ä¹æ”¾ç€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼Œå¯¹å †åƒåœ¾å›æ”¶å‰çš„ç¬¬ä¸€æ­¥å°±æ˜¯è¦åˆ¤æ–­å“ªäº›å¯¹è±¡å·²ç»æ­»äº¡(å³ä¸èƒ½å†è¢«ä»»ä½•é€”å¾„ä½¿ç”¨çš„å¯¹è±¡)

#### å¼•ç”¨è®¡æ•°æ³•
ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨ï¼Œè®¡æ•°å™¨å°±åŠ 1ã€‚å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±å‡1ã€‚ä»»ä½•æ—¶å€™è®¡æ•°å™¨ä¸º0 çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚

è¿™ä¸ªæ–¹æ³•å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œä½†æ˜¯ç›®å‰ä¸»æµçš„è™šæ‹Ÿæœºä¸­æ²¡æœ‰é€‰æ‹©è¿™ä¸ªç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œæœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³**å¯¹è±¡ä¹‹å‰ç›¸äº’å¾ªç¯å¼•ç”¨**çš„é—®é¢˜ã€‚æ‰€è°“å¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨é—®é¢˜ï¼Œé€šè¿‡ä¸‹é¢ä»£ç æ‰€ç¤º:é™¤äº†å¯¹è±¡aå’Œbç›¸äº’å¼•ç”¨ç€å¯¹æ–¹ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å†æ— ä»»ä½•å¼•ç”¨ã€‚ä½†æ˜¯å®ƒä»¬å› ä¸ºäº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å™¨éƒ½ä¸ä¸º0ï¼Œäºæ˜¯å¼•ç”¨è®¡æ•°å™¨æ³•æ— æ³•é€šçŸ¥GCå›æ”¶å™¨å›æ”¶å®ƒä»¬ã€‚

```java
public class CounterGC{
    Object instance = null;
    public static void main(String[] args){
      CounterGC a = new CounterGC();
      CounterGC b = new CounterGC();
      a.instance = b;
      b.instance = a;
      a = null;
      b = null;
    }
}
```

#### å¯è¾¾æ€§åˆ†æç®—æ³•
è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º"GC Roots"çš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼ŒèŠ‚ç‚¹æ‰€èµ°è¿‡çš„è·¯
å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿çš„è¯ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ—¶ä¸å¯ç”¨çš„ã€‚

`GC Rootsæ ¹èŠ‚ç‚¹`:ç±»åŠ è½½å™¨ã€Threadã€è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ã€staticæˆå‘˜ã€å¸¸é‡å¼•ç”¨ã€æœ¬åœ°æ–¹æ³•æ ˆçš„å˜é‡ç­‰ç­‰.
![](JVM-Fundamentals/8.png)

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡
è¿è¡Œæ—¶å¸¸é‡æ± ä¸»è¦å›æ”¶çš„æ˜¯åºŸå¼ƒçš„å¸¸é‡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ—¶åºŸå¼ƒå¸¸é‡å‘¢?
å‡å¦‚åœ¨å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸²"abc"ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½•Stringå¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡"abc"å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿå†…å­˜å›æ”¶çš„è¯è€Œä¸”æœ‰å¿…è¦çš„è¯ï¼ˆå†…å­˜ä¸å¤Ÿç”¨æ—¶æ‰ä¼šå‘ç”Ÿå›æ”¶ï¼‰ï¼Œ"abc"ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± ã€‚

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»
éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶:
* è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚
* åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚
* è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚
è™šæ‹Ÿæœºå¯ä»¥å¯¹æ»¡è¶³ä¸Šè¿°3ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œä»…ä»…æ˜¯"**å¯ä»¥**"ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ä¸é€‚ç”¨äº†å°±å¿…ç„¶ä¼šè¢«å›æ”¶ã€‚


### åƒåœ¾å›æ”¶ç®—æ³•
![](JVM-Fundamentals/9.png)

#### æ ‡è®°-æ¸…é™¤ç®—æ³•
å®ƒæ˜¯æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œè¿™ä¸ªç®—æ³•åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œ`æ ‡è®°`å’Œ`æ¸…é™¤`ã€‚é¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆå
ç»Ÿä¸€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚å®ƒæœ‰ä¸¤ä¸ªä¸è¶³çš„åœ°æ–¹:
1. æ•ˆç‡é—®é¢˜ï¼Œæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜;
2. ç©ºé—´é—®é¢˜ï¼Œæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„ç¢ç‰‡;
![](JVM-Fundamentals/9.1.png)

#### å¤åˆ¶ç®—æ³•
ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œå¤åˆ¶ç®—æ³•å‡ºç°äº†ã€‚å®ƒå¯ä»¥æŠŠå†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚
å½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œåï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—åŒºï¼Œç„¶åå†æŠŠä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚
è¿™æ ·å°±ä½¿æ¯æ¬¡çš„å†…å­˜å›æ”¶éƒ½æ˜¯å¯¹å†…å­˜åŒºé—´çš„ä¸€åŠè¿›è¡Œå›æ”¶
![](JVM-Fundamentals/9.2.png)

#### æ ‡è®°-æ•´ç†ç®—æ³•
æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹æå‡ºçš„ä¸€ç§æ ‡è®°ç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹å’Œâ€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†æ˜¯åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€æ®µç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜
![](JVM-Fundamentals/9.3.png)

#### åˆ†ä»£æ”¶é›†ç®—æ³•
ç°åœ¨çš„å•†ç”¨è™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨"åˆ†ä»£æ”¶é›†"ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å°±æ˜¯æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ†ä¸ºå‡ å—ã€‚
ä¸€èˆ¬å°†javaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚
åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½æœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©å¤åˆ¶ç®—æ³•ï¼Œåªè¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†ã€‚
è€Œè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»å‡ ç‡æ—¶æ¯”è¾ƒé«˜çš„ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ– è€…â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

### åƒåœ¾æ”¶é›†å™¨
![](JVM-Fundamentals/10.png)
#### Serialæ”¶é›†å™¨
Serial(ä¸²è¡Œ)æ”¶é›†å™¨æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚
å¤§å®¶çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚
å®ƒçš„`å•çº¿ç¨‹`çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹( â€œStop The Worldâ€ )ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚
**æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**
![](JVM-Fundamentals/10.1.png)
è™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬å½“ç„¶çŸ¥é“Stop The Worldå¸¦æ¥çš„ä¸è‰¯ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥åœ¨åç»­çš„åƒåœ¾æ”¶é›†å™¨è®¾è®¡ä¸­åœé¡¿æ—¶é—´åœ¨ä¸æ–­ç¼©çŸ­(ä»ç„¶è¿˜æœ‰åœé¡¿ï¼Œå¯»æ‰¾æœ€ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨çš„è¿‡ç¨‹ä»ç„¶åœ¨ç»§ç»­)ã€‚
ä½†æ˜¯Serialæ”¶é›†å™¨æœ‰æ²¡æœ‰ä¼˜äºå…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„åœ°æ–¹å‘¢?
å½“ç„¶æœ‰ï¼Œå®ƒç®€å•è€Œé«˜æ•ˆ(ä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”)ã€‚ Serialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œè‡ªç„¶å¯ä»¥è·å¾—å¾ˆé«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚Serialæ”¶é›†å™¨å¯¹äºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ¥è¯´æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

#### ParNewæ”¶é›†å™¨
ParNewæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨çš„`å¤šçº¿ç¨‹`ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸º(æ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰)å’ŒSerialæ”¶é›†å™¨å®Œå…¨ä¸€æ ·ã€‚
**æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**
![](JVM-Fundamentals/10.2.png)
å®ƒæ˜¯è®¸å¤šè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºçš„é¦–è¦é€‰æ‹©ï¼Œé™¤äº†Serialæ”¶é›†å™¨å¤–ï¼Œåªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨(çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œåé¢ä¼šä»‹ç»åˆ°)é…åˆå·¥ä½œã€‚

#### Parallel Scavengeæ”¶é›†å™¨(JDK1.8)
Parallel Scavenge æ”¶é›†å™¨ç±»ä¼¼äºParNewæ”¶é›†å™¨ã€‚
Parallel Scavengeæ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯`ååé‡`(é«˜æ•ˆç‡çš„åˆ©ç”¨CPU)ã€‚æ‰€è°“ååé‡å°±æ˜¯CPUä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚
CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„`åœé¡¿æ—¶é—´`(æé«˜ç”¨æˆ·ä½“éªŒ)ã€‚ Parallel Scavengeæ”¶é›†å™¨æä¾›äº†å¾ˆå¤šå‚æ•°ä¾›ç”¨æˆ·æ‰¾åˆ°æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–æœ€å¤§ååé‡ï¼Œå¦‚æœå¯¹äºæ”¶é›†å™¨è¿ä½œä¸å¤ªäº†è§£çš„è¯ï¼Œæ‰‹å·¥ä¼˜åŒ–å­˜åœ¨çš„è¯å¯ä»¥é€‰æ‹©æŠŠå†…å­˜ç®¡ç†ä¼˜åŒ–äº¤ç»™è™šæ‹Ÿæœºå»å®Œæˆä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚
**æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**
![](JVM-Fundamentals/10.2.png)

#### Serial Oldæ”¶é›†å™¨
Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ª`å•çº¿ç¨‹`æ”¶é›†å™¨ï¼Œé‡‡ç”¨**æ ‡è®°-æ•´ç†**ç®—æ³•ã€‚
å®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”:ä¸€ç§ç”¨é€”æ˜¯åœ¨JDK1.5ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œå¦ä¸€ç§ç”¨é€”æ˜¯ä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆã€‚

#### Parallel Oldæ”¶é›†å™¨
Parallel Scavengeæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚ä½¿ç”¨`å¤šçº¿ç¨‹`å’Œ**æ ‡è®°-æ•´ç†**ç®—æ³•ã€‚
åœ¨æ³¨é‡ååé‡ä»¥åŠCPUèµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavengeæ”¶é›†å™¨å’ŒParallel Oldæ”¶é›†å™¨ã€‚

#### **CMSæ”¶é›†å™¨**
å¹¶è¡Œå’Œå¹¶å‘æ¦‚å¿µè¡¥å……:
* å¹¶è¡Œ(Parallel) :æŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚ 
* å¹¶å‘(Concurrent):æŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œ(ä½†ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œ)ï¼Œç”¨æˆ·ç¨‹åº åœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†å™¨è¿è¡Œåœ¨å¦ä¸€ä¸ªCPUä¸Šã€‚

CMS(Concurrent Mark Sweep)æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒè€Œéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ã€‚
CMS(Concurrent Mark Sweep)æ”¶é›†å™¨æ˜¯HotSpotè™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹(åŸºæœ¬ä¸Š)åŒæ—¶å·¥ä½œã€‚

ä»åå­—ä¸­çš„Mark Sweepè¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMSæ”¶é›†å™¨æ˜¯ä¸€ç§**æ ‡è®°-æ¸…é™¤**ç®—æ³•å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚
æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤:
* åˆå§‹æ ‡è®°(CMS initial mark): æš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹ï¼Œå¹¶è®°å½•ä¸‹ç›´æ¥ä¸rootç›¸è¿çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« 
* å¹¶å‘æ ‡è®°(CMS concurrent mark): **åŒæ—¶å¼€å¯GCå’Œç”¨æˆ·çº¿ç¨‹**ï¼Œç”¨ä¸€ä¸ªé—­åŒ…ç»“æ„å»è®°å½•å¯è¾¾å¯¹è±¡ã€‚ä½†åœ¨è¿™ä¸ªé˜¶æ®µç»“æŸï¼Œè¿™ä¸ªé—­åŒ…ç»“æ„å¹¶ä¸èƒ½ä¿è¯åŒ…å«å½“å‰æ‰€æœ‰çš„å¯è¾¾å¯¹è±¡ã€‚å› ä¸ºç”¨æˆ·çº¿ç¨‹å¯èƒ½ä¼šä¸æ–­çš„æ›´æ–°å¼•ç”¨åŸŸï¼Œæ‰€ä»¥GC çº¿ç¨‹æ— æ³•ä¿è¯å¯è¾¾æ€§åˆ†æçš„å®æ—¶æ€§ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•é‡Œä¼šè·Ÿè¸ªè®°å½•è¿™äº›å‘ç”Ÿå¼•ç”¨æ›´æ–°çš„åœ°æ–¹ã€‚
* é‡æ–°æ ‡è®°(CMS remark): é‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸€èˆ¬ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µçš„æ—¶é—´ç¨é•¿ï¼Œè¿œè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶ æ®µæ—¶é—´çŸ­
* å¹¶å‘æ¸…é™¤(CMS concurrent sweep): å¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶GCçº¿ç¨‹å¼€å§‹å¯¹ä¸ºæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ã€‚
![](JVM-Fundamentals/10.3.png)
CMSä¸»è¦ä¼˜ç‚¹:å¹¶å‘æ”¶é›†ã€ä½åœé¡¿ã€‚
ä½†æ˜¯å®ƒæœ‰ä¸‹é¢ä¸‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹:
* å¯¹CPUèµ„æºæ•æ„Ÿ;
* æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾;
* å®ƒä½¿ç”¨çš„å›æ”¶ç®—æ³•-**æ ‡è®°-æ¸…é™¤**ç®—æ³•ä¼šå¯¼è‡´æ”¶é›†ç»“æŸæ—¶ä¼šæœ‰å¤§é‡ç©ºé—´ç¢ç‰‡äº§ç”Ÿã€‚

#### G1æ”¶é›†å™¨
G1 (Garbage-First)æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨,ä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨. ä»¥æé«˜æ¦‚ç‡æ»¡è¶³ GCåœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶,è¿˜å…·å¤‡é«˜ååé‡æ€§èƒ½ç‰¹å¾.
![](JVM-Fundamentals/10.3.png)
è¢«è§†ä¸ºJDK1.7ä¸­HotSpotè™šæ‹Ÿæœºçš„ä¸€ä¸ªé‡è¦è¿›åŒ–ç‰¹å¾ã€‚å®ƒå…·å¤‡ä¸€ä¸‹ç‰¹ç‚¹:
* å¹¶è¡Œä¸å¹¶å‘:G1èƒ½å……åˆ†åˆ©ç”¨CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ªCPU(CPUæˆ–è€…CPUæ ¸å¿ƒ)æ¥ç¼©çŸ­Stop- The-Worldåœé¡¿æ—¶é—´ã€‚éƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨åŸæœ¬éœ€è¦åœé¡¿Javaçº¿ç¨‹æ‰§è¡Œçš„GCåŠ¨ä½œï¼ŒG1æ”¶é›†å™¨ä»ç„¶å¯ä»¥é€šè¿‡å¹¶å‘çš„æ–¹å¼è®©javaç¨‹åºç»§ç»­æ‰§è¡Œ 
* åˆ†ä»£æ”¶é›†:è™½ç„¶G1å¯ä»¥ä¸éœ€è¦å…¶ä»–æ”¶é›†å™¨é…åˆå°±èƒ½ç‹¬ç«‹ç®¡ç†æ•´ä¸ªGCå †ï¼Œä½†æ˜¯è¿˜æ˜¯ä¿ç•™äº†åˆ†ä»£çš„æ¦‚å¿µã€‚ ç©ºé—´æ•´ åˆ:ä¸CMSçš„â€œæ ‡è®°â€“æ¸…ç†â€ç®—æ³•ä¸åŒï¼ŒG1ä»æ•´ä½“æ¥çœ‹æ˜¯åŸºäº**æ ‡è®°æ•´ç†**ç®—æ³•å®ç°çš„æ”¶é›†å™¨;ä»å±€éƒ¨ä¸Šæ¥çœ‹æ˜¯åŸºäº**æ ‡è®°å¤åˆ¶**ç®—æ³•å®ç°çš„
* **å¯é¢„æµ‹çš„åœé¡¿**:è¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€ä¸ªå¤§ä¼˜åŠ¿ï¼Œé™ä½åœé¡¿æ—¶é—´æ˜¯G1 å’Œ CMS å…±åŒçš„å…³æ³¨ç‚¹ï¼Œä½†G1é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…

G1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:
* åˆå§‹æ ‡è®°
* å¹¶å‘æ ‡è®°
* æœ€ç»ˆæ ‡è®°
* ç­›é€‰å›æ”¶

G1æ”¶é›†å™¨åœ¨åå°ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„Region(è¿™ä¹Ÿå°±æ˜¯å®ƒçš„å å­—Garbage-Firstçš„ç”±æ¥)ã€‚è¿™ç§ä½¿ç”¨Regionåˆ’åˆ†å†…å­˜ç©ºé—´ä»¥åŠæœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼ï¼Œä¿è¯äº†GFæ”¶é›†å™¨åœ¨æœ‰é™æ—¶é—´å†…å¯ä»¥å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡(æŠŠå†…å­˜åŒ–æ•´ä¸ºé›¶)ã€‚

#### æ€ä¹ˆé€‰æ‹©åƒåœ¾æ”¶é›†å™¨?ï¼ˆå°½é‡ç”±JVMè‡ªå·±é€‰æ‹©ï¼‰
1. ä¼˜å…ˆè°ƒæ•´å †çš„å¤§å°è®©æœåŠ¡å™¨è‡ªå·±æ¥é€‰æ‹©
2. å¦‚æœå†…å­˜å°äº100mï¼Œä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨
3. å¦‚æœæ˜¯å•æ ¸ï¼Œå¹¶ä¸”æ²¡æœ‰åœé¡¿æ—¶é—´çš„è¦æ±‚ï¼Œä¸²è¡Œæˆ–JVMè‡ªå·±é€‰æ‹© 
4. å¦‚æœå…è®¸åœé¡¿æ—¶é—´è¶…è¿‡1ç§’ï¼Œé€‰æ‹©å¹¶è¡Œæˆ–è€…JVMè‡ªå·±é€‰
5. å¦‚æœå“åº”æ—¶é—´æœ€é‡è¦ï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡1ç§’ï¼Œä½¿ç”¨å¹¶å‘æ”¶é›†å™¨
å®˜æ–¹æ¨èZGC(javaæœ€æ–°ç‰ˆæœ¬åƒåœ¾æ”¶å™¨å™¨ï¼Œå¯é¢„æµ‹çš„åœé¡¿æœ€ä½2ms)ï¼Œæ€§èƒ½é«˜ã€‚

## JDKæ€§èƒ½è°ƒä¼˜ç›‘æ§å·¥å…·
è™šæ‹Ÿæœºå‚æ•°åˆ†æç½‘ç«™ï¼šhttps://www.perfma.com/product/opts
### jps
æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„javaè¿›ç¨‹æƒ…å†µ
```bash
gdeMacBook-Pro:~ g$ jps
94673 AppServiceApplication
54995
55011 RemoteMavenServer36
94696 AppServiceApplication
96956 Jps
```
(ç©ºç™½çš„54995æ˜¯idea)
### Jinfo
æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„Javaç¨‹åºçš„æ‰©å±•å‚æ•°
#### æŸ¥çœ‹JVMçš„å‚æ•°
```bash
gdeMacBook-Pro:~ g$ jinfo -flags 94673
VM Flags:
-XX:-BytecodeVerificationLocal -XX:-BytecodeVerificationRemote -XX:CICompilerCount=4 -XX:ConcGCThreads=3 -XX:G1ConcRefinementThreads=10 -XX:G1HeapRegionSize=1048576 -XX:GCDrainStackTargetSize=64 -XX:InitialHeapSize=268435456 -XX:+ManagementServer -XX:MarkStackSize=4194304 -XX:MaxHeapSize=4294967296 -XX:MaxNewSize=2576351232 -XX:MinHeapDeltaBytes=1048576 -XX:NonNMethodCodeHeapSize=7549744 -XX:NonProfiledCodeHeapSize=244108496 -XX:ProfiledCodeHeapSize=0 -XX:ReservedCodeCacheSize=251658240 -XX:+SegmentedCodeCache -XX:TieredStopAtLevel=1 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC
```
#### æŸ¥çœ‹javaç³»ç»Ÿå±æ€§
```bash
jinfo -sysprops 94673
```


### Jstat
jstatå‘½ä»¤å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†çš„ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ã€‚å‘½ä»¤æ ¼å¼:
jstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´/æ¯«ç§’] [æŸ¥è¯¢æ¬¡æ•°]
```bash
gdeMacBook-Pro:~ g$ jstat -gc 94673
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
 0.0   2048.0  0.0   2048.0 96256.0  68608.0   163840.0   132934.6  131280.0 127368.5 14720.0 13850.3    185    1.219   0      0.000  112     0.661    1.880
```
* S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°
* S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°
* S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
* S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
* ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°
* EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°
* OCï¼šè€å¹´ä»£å¤§å°
* OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å°
* MCï¼šæ–¹æ³•åŒºå¤§å°
* MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°
* CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°
* CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°
* YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
* YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
* FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
* FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
* GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´

### Jmap
å¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜ä¿¡æ¯
#### å †çš„å¯¹è±¡ç»Ÿè®¡
```bash
gdeMacBook-Pro:~ g$ jmap -histo 94673 > xxx.txt
```
éƒ¨åˆ†å¦‚ä¸‹
```text
 num     #instances         #bytes  class name (module)
-------------------------------------------------------
   1:        380588       39857240  [B (java.base@11.0.4)
   2:         71568        8387344  [Ljava.lang.Object; (java.base@11.0.4)
   3:        301995        7247880  java.lang.String (java.base@11.0.4)
   4:         25762        5316280  [I (java.base@11.0.4)
   5:         47736        4200768  java.lang.reflect.Method (java.base@11.0.4)
   6:        126275        4040800  java.util.concurrent.ConcurrentHashMap$Node (java.base@11.0.4)
   7:         69142        3871952  java.util.LinkedHashMap (java.base@11.0.4)
   8:          2483        3656120  [C (java.base@11.0.4)
   9:         46566        3352752  io.netty.channel.DefaultChannelHandlerContext
  10:        104582        3346624  java.util.HashMap$Node (java.base@11.0.4)
  11:         20887        2551232  java.lang.Class (java.base@11.0.4)
  12:         32461        2077504  java.util.concurrent.ConcurrentHashMap (java.base@11.0.4)
  13:         48062        1922480  java.util.HashMap$KeyIterator (java.base@11.0.4)
  14:         17400        1720040  [Ljava.util.HashMap$Node; (java.base@11.0.4)
  15:          2184        1432704  io.netty.util.internal.shaded.org.jctools.queues.MpscArrayQueue
  16:         35693        1427720  java.util.LinkedHashMap$Entry (java.base@11.0.4)
  17:         88742        1419872  java.lang.Object (java.base@11.0.4)
  18:          1671        1195280  [Ljava.util.concurrent.ConcurrentHashMap$Node; (java.base@11.0.4)
  19:         10270        1150240  sun.nio.ch.SocketChannelImpl (java.base@11.0.4)
  20:         10237        1064648  io.netty.channel.socket.nio.NioSocketChannel
  21:         42359        1016616  java.util.ArrayList (java.base@11.0.4)
  22:         60868         973888  java.lang.Integer (java.base@11.0.4)
  23:         20436         817440  io.netty.util.DefaultAttributeMap$DefaultAttribute
  24:         10533         758376  org.springframework.core.type.classreading.AnnotationMetadataReadingVisitor
  25:         18570         742800  com.meituan.service.mobile.mtthrift.mtrace.MtraceServerTBinaryProtocol$Factory
  26:         10239         737208  io.netty.channel.DefaultChannelPipeline$HeadContext
  27:         10239         737208  io.netty.channel.DefaultChannelPipeline$TailContext
  28:         30914         729768  [Ljava.lang.Class; (java.base@11.0.4)
  29:         21894         700608  java.util.concurrent.locks.ReentrantLock$NonfairSync (java.base@11.0.4)
------çœç•¥----
```
* Num:åºå·
* Instances:å®ä¾‹æ•°é‡
* Bytes:å ç”¨ç©ºé—´å¤§å°
* Class Name:ç±»å

#### å †ä¿¡æ¯
```bash
gdeMacBook-Pro:~ g$ jmap -heap 94673
Error: -heap option used
Cannot connect to core dump or remote debug server. Use jhsdb jmap instead
```
jdk9åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨jmap -heap pidå‘½ä»¤æŸ¥çœ‹å½“å‰heapä½¿ç”¨æƒ…å†µæ—¶ï¼Œå‘ç°æŠ¥é”™ï¼Œæç¤ºéœ€è¦ä½¿ç”¨jhsdb jmapæ¥æ›¿ä»£
```bash
gdeMacBook-Pro:~ g$ jhsdb jmap --heap --pid 94673
```




